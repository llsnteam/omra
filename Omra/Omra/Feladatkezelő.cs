///////////////////////////////////////////////////////////
//  Feladatkezelõ.cs
//  Implementation of the Class Feladatkezelõ
//  Generated by Enterprise Architect
//  Created on:      02-ápr.-2016 10:16:28
//  Original author: Dániel
///////////////////////////////////////////////////////////


using Adatkezelõ;
using Omra;
using System;
using System.Collections.Generic;
using System.Linq;

namespace Adatkezelõ 
{
	public class Feladatkezelõ : IFeladatkezelõ
    {

        DatabaseElements DE = new DatabaseElements();
        private Dolgozó célszemély;
        private Bûneset buneset;

        public Dolgozó GetCélszemély { get { return célszemély; } }
        public Bûneset Buneset { get { return buneset; } }

        public void FeladatMentés(Dolgozó célszemély, Bûneset bûneset)
        {
            var ujfelvdolg = new FelvettDolgozok()
            {
                bunesetID = bûneset.GetAzonosító,
                dolgozoID = célszemély.GetAzonosító(),
                felvetel_idopontja = DateTime.Now
            };
            DE.FelvettDolgozok.Add(ujfelvdolg);
            DE.SaveChanges();
        }

        public List<Feladat> FeladatokLekérdezése(Dolgozó dolgozo)
        {
            decimal id = dolgozo.GetAzonosító();    // linq nem szereti ha ott kérem el
            List<Feladat> vissza = new List<Feladat>();

            var bunesetek = from dolg in DE.FelvettDolgozok
                        where dolg.dolgozoID == id
                        select new { dolg.Bunesetek.bunesetID, dolg.Bunesetek.leiras, dolg.Bunesetek.felvetel, dolg.Bunesetek.allapot };

            if (dolgozo.GetBeosztás() == Rang.Ornagy)
            {
                bunesetek = from bun in DE.Bunesetek
                                where bun.felelos_ornagy == id
                                select new { bun.bunesetID, bun.leiras, bun.felvetel,bun.allapot };
            }

            foreach (var item in bunesetek)
            {
                vissza.Add(new Feladat(item.leiras, dolgozo, item.felvetel,(FÁllapot)Enum.Parse(typeof(FÁllapot),item.allapot)));
            }
            return vissza;
        }
    }//end Feladatkezelõ

}//end namespace Adatkezelõ